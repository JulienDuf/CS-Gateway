"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const express = require("express");
const fetch = require("node-fetch");
const util_1 = require("util");
const querystring = require("querystring");
class Auth {
    constructor() {
        this.router = express.Router();
        this.router.post('/login', this.login.bind(this));
        this.router.get('/logout', this.logout.bind(this));
        this.router.get('/isloggedin', this.isLoggedIn.bind(this));
    }
    // POST /login
    // email: the user's email
    // password: the user's password
    // remember: true or false, if the user wants to be remembered, for the remember me feature
    async login(req, res) {
        let email = req.body.email;
        let password = req.body.password;
        let rememberMe = req.body.remember;
        if (util_1.isNullOrUndefined(email) || util_1.isNullOrUndefined(password)
            || email === "" || password === "") {
            res.json({ error: "Email and password fields must not be empty." });
            res.statusCode = 422;
            return;
        }
        let body = querystring.stringify({
            client_id: process.env.STS_CLIENT_ID,
            client_secret: process.env.STS_CLIENT_SECRET,
            scope: process.env.STS_CLIENT_SCOPES,
            grant_type: 'password',
            username: email,
            password: password
        });
        try {
            let response = await fetch(`${process.env.STS_URL}/connect/token`, {
                method: 'POST',
                body: body,
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
            }).then(r => r.json());
            if (response.access_token && response.refresh_token) {
                req.session.access_token = response.access_token;
                let payload = JSON.parse(Buffer.from(response.access_token.split('.')[1], 'base64').toString());
                req.session.access_token_expiration = payload.exp;
                if (rememberMe) {
                    req.session.refresh_token = response.refresh_token;
                }
                res.json({
                    Success: true
                });
            }
            else {
                res.statusCode = 401;
                res.json({
                    Success: false
                });
            }
        }
        catch (e) {
            res.json({ error: "An error occured." });
            console.log(e);
            res.statusCode = 500;
            return;
        }
    }
    // GET /logout 
    logout(req, res) {
        if (req.session.access_token) {
            req.session.destroy((err) => {
                if (err) {
                    console.log(err);
                    res.statusCode = 500;
                    res.json({ Success: false });
                }
                else {
                    res.json({ Success: true });
                }
            });
        }
    }
    //GET /isloggedin
    isLoggedIn(req, res) {
        if (req.session.access_token) {
            res.json({
                logged_in: true
            });
        }
        else {
            res.json({
                logged_in: false
            });
        }
    }
}
exports.Auth = Auth;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUM7WUFDeEIsR0FBRyxDQUFDLElBQUksQ0FBQztnQkFDTCxTQUFTLEVBQUUsSUFBSTthQUNsQixDQUFDLENBQUM7U0FDTjthQUFNO1lBQ0gsR0FBRyxDQUFDLElBQUksQ0FBQztnQkFDTCxTQUFTLEVBQUUsS0FBSzthQUNuQixDQUFDLENBQUM7U0FDTjtJQUNMLENBQUM7Q0FDSjtBQTdGRCxvQkE2RkMiLCJmaWxlIjoicm91dGUvYXV0aC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGV4cHJlc3MgZnJvbSAnZXhwcmVzcyc7XHJcbmltcG9ydCAqIGFzIGZldGNoIGZyb20gJ25vZGUtZmV0Y2gnO1xyXG5pbXBvcnQgeyBpc051bGxPclVuZGVmaW5lZCB9IGZyb20gJ3V0aWwnO1xyXG5pbXBvcnQgeyBhcHBDb25maWcgfSBmcm9tICcuLi9hcHAtY29uZmlnJztcclxuaW1wb3J0ICogYXMgcXVlcnlzdHJpbmcgZnJvbSAncXVlcnlzdHJpbmcnO1xyXG5cclxuZXhwb3J0IGNsYXNzIEF1dGgge1xyXG4gICAgcHVibGljIHJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7XHJcblxyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgICAgdGhpcy5yb3V0ZXIucG9zdCgnL2xvZ2luJywgdGhpcy5sb2dpbi5iaW5kKHRoaXMpKTtcclxuICAgICAgICB0aGlzLnJvdXRlci5nZXQoJy9sb2dvdXQnLCB0aGlzLmxvZ291dC5iaW5kKHRoaXMpKTtcclxuICAgICAgICB0aGlzLnJvdXRlci5nZXQoJy9pc2xvZ2dlZGluJywgdGhpcy5pc0xvZ2dlZEluLmJpbmQodGhpcykpOyBcclxuICAgIH1cclxuICAgIFxyXG4gICAgLy8gUE9TVCAvbG9naW5cclxuICAgIC8vIGVtYWlsOiB0aGUgdXNlcidzIGVtYWlsXHJcbiAgICAvLyBwYXNzd29yZDogdGhlIHVzZXIncyBwYXNzd29yZFxyXG4gICAgLy8gcmVtZW1iZXI6IHRydWUgb3IgZmFsc2UsIGlmIHRoZSB1c2VyIHdhbnRzIHRvIGJlIHJlbWVtYmVyZWQsIGZvciB0aGUgcmVtZW1iZXIgbWUgZmVhdHVyZVxyXG4gICAgcHJpdmF0ZSBhc3luYyBsb2dpbihyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKSB7XHJcbiAgICAgICAgbGV0IGVtYWlsID0gcmVxLmJvZHkuZW1haWw7XHJcbiAgICAgICAgbGV0IHBhc3N3b3JkID0gcmVxLmJvZHkucGFzc3dvcmQ7XHJcbiAgICAgICAgbGV0IHJlbWVtYmVyTWUgPSByZXEuYm9keS5yZW1lbWJlcjtcclxuICAgIFxyXG4gICAgICAgIGlmKGlzTnVsbE9yVW5kZWZpbmVkKGVtYWlsKSB8fCBpc051bGxPclVuZGVmaW5lZChwYXNzd29yZCkgXHJcbiAgICAgICAgICAgIHx8IGVtYWlsID09PSBcIlwiIHx8IHBhc3N3b3JkID09PSBcIlwiKSB7XHJcbiAgICAgICAgICAgIHJlcy5qc29uKHsgZXJyb3I6IFwiRW1haWwgYW5kIHBhc3N3b3JkIGZpZWxkcyBtdXN0IG5vdCBiZSBlbXB0eS5cIiB9KTtcclxuICAgICAgICAgICAgcmVzLnN0YXR1c0NvZGUgPSA0MjI7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBib2R5ID0gcXVlcnlzdHJpbmcuc3RyaW5naWZ5KHtcclxuICAgICAgICAgICAgY2xpZW50X2lkOiBwcm9jZXNzLmVudi5TVFNfQ0xJRU5UX0lELFxyXG4gICAgICAgICAgICBjbGllbnRfc2VjcmV0OiBwcm9jZXNzLmVudi5TVFNfQ0xJRU5UX1NFQ1JFVCxcclxuICAgICAgICAgICAgc2NvcGU6IHByb2Nlc3MuZW52LlNUU19DTElFTlRfU0NPUEVTLFxyXG4gICAgICAgICAgICBncmFudF90eXBlOiAncGFzc3dvcmQnLFxyXG4gICAgICAgICAgICB1c2VybmFtZTogZW1haWwsXHJcbiAgICAgICAgICAgIHBhc3N3b3JkOiBwYXNzd29yZFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBsZXQgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChgJHtwcm9jZXNzLmVudi5TVFNfVVJMfS9jb25uZWN0L3Rva2VuYCwge1xyXG4gICAgICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXHJcbiAgICAgICAgICAgICAgICBib2R5OiBib2R5LFxyXG4gICAgICAgICAgICAgICAgaGVhZGVyczogeydDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJ31cclxuICAgICAgICAgICAgfSkudGhlbihyID0+IHIuanNvbigpKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGlmKHJlc3BvbnNlLmFjY2Vzc190b2tlbiAmJiByZXNwb25zZS5yZWZyZXNoX3Rva2VuKSB7XHJcbiAgICAgICAgICAgICAgICByZXEuc2Vzc2lvbi5hY2Nlc3NfdG9rZW4gPSByZXNwb25zZS5hY2Nlc3NfdG9rZW47XHJcbiAgICAgICAgICAgICAgICBsZXQgcGF5bG9hZCA9IEpTT04ucGFyc2UoQnVmZmVyLmZyb20ocmVzcG9uc2UuYWNjZXNzX3Rva2VuLnNwbGl0KCcuJylbMV0sICdiYXNlNjQnKS50b1N0cmluZygpKTtcclxuICAgICAgICAgICAgICAgIHJlcS5zZXNzaW9uLmFjY2Vzc190b2tlbl9leHBpcmF0aW9uID0gcGF5bG9hZC5leHA7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIGlmKHJlbWVtYmVyTWUpe1xyXG4gICAgICAgICAgICAgICAgICAgIHJlcS5zZXNzaW9uLnJlZnJlc2hfdG9rZW4gPSByZXNwb25zZS5yZWZyZXNoX3Rva2VuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmVzLmpzb24oe1xyXG4gICAgICAgICAgICAgICAgICAgIFN1Y2Nlc3M6IHRydWVcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmVzLnN0YXR1c0NvZGUgPSA0MDE7XHJcbiAgICAgICAgICAgICAgICByZXMuanNvbih7XHJcbiAgICAgICAgICAgICAgICAgICAgU3VjY2VzczogZmFsc2VcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9ICAgICBcclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIHJlcy5qc29uKHsgZXJyb3I6IFwiQW4gZXJyb3Igb2NjdXJlZC5cIiB9KTtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coZSk7XHJcbiAgICAgICAgICAgIHJlcy5zdGF0dXNDb2RlID0gNTAwO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIEdFVCAvbG9nb3V0IFxyXG4gICAgcHJpdmF0ZSBsb2dvdXQocmVxOiBleHByZXNzLlJlcXVlc3QsIHJlczogZXhwcmVzcy5SZXNwb25zZSkge1xyXG4gICAgICAgIGlmKHJlcS5zZXNzaW9uLmFjY2Vzc190b2tlbikge1xyXG4gICAgICAgICAgICByZXEuc2Vzc2lvbi5kZXN0cm95KChlcnIpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzLnN0YXR1c0NvZGUgPSA1MDA7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzLmpzb24oeyBTdWNjZXNzOiBmYWxzZSB9KTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzLmpzb24oeyBTdWNjZXNzOiB0cnVlIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvL0dFVCAvaXNsb2dnZWRpblxyXG4gICAgcHJpdmF0ZSBpc0xvZ2dlZEluKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UpIHtcclxuICAgICAgICBpZihyZXEuc2Vzc2lvbi5hY2Nlc3NfdG9rZW4pe1xyXG4gICAgICAgICAgICByZXMuanNvbih7XHJcbiAgICAgICAgICAgICAgICBsb2dnZWRfaW46IHRydWVcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmVzLmpzb24oe1xyXG4gICAgICAgICAgICAgICAgbG9nZ2VkX2luOiBmYWxzZVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuIl19
