"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const express = require("express");
const path = require("path");
const logger = require("morgan");
const cookieParser = require("cookie-parser");
const bodyParser = require("body-parser");
const cors = require("cors");
const session = require("express-session");
const redisStore = require("connect-redis");
const httpProxy = require("http-proxy-middleware");
const querystring = require("querystring");
const fetch = require("node-fetch");
const RedisStore = redisStore(session);
const redis = require("redis");
const auth_1 = require("./route/auth");
const app_config_1 = require("./app-config");
const proxy_config_1 = require("./proxy-config");
class Application {
    static bootstrap() {
        return new Application();
    }
    constructor() {
        this.app = express();
        this.config();
        this.routes();
    }
    config() {
        this.app.use(logger('dev'));
        this.app.use(bodyParser.json());
        this.app.use(bodyParser.urlencoded({ extended: true }));
        this.app.use(cookieParser(process.env.COOKIE_SECRET));
        this.app.use(express.static(path.join(__dirname, '../public')));
        this.app.use(cors());
        let redisClient = redis.createClient({
            host: process.env.REDIS_HOST,
            port: process.env.REDIS_PORT,
            password: process.env.REDIS_PASSWORD
        });
        redisClient.on("error", function (err) {
            console.log("Error " + err);
        });
        this.app.use(session({
            name: 'csgames-session',
            store: new RedisStore({ client: redisClient }),
            resave: false,
            saveUninitialized: true,
            secret: process.env.COOKIE_SECRET,
            cookie: {
                // TODO: secure: true,
                httpOnly: true,
                domain: process.env.APP_URL,
                path: '/',
                expires: app_config_1.appConfig.cookieExpiration
            }
        }));
        this.app.use(function (req, res, next) {
            res.setHeader("Access-Control-Allow-Origin", process.env.APP_URL);
            res.setHeader("X-XSS-Protection", "1; mode=block");
            res.setHeader("Content-security-policy", app_config_1.appConfig.contentSecurityPolicy);
            res.setHeader("X-frame-options", app_config_1.appConfig.xFrameOptions);
            res.setHeader("X-content-type", app_config_1.appConfig.xContentType);
            // TODO: res.setHeader("Strict-transport-security", appConfig.strictTransportSecurity);
            return next();
        });
        this.app.disable('x-powered-by');
    }
    routes() {
        const auth = new auth_1.Auth();
        this.app.use(httpProxy(proxy_config_1.proxyConfig.path, {
            target: proxy_config_1.proxyConfig.target,
            router: proxy_config_1.proxyConfig.router,
            logLevel: proxy_config_1.proxyConfig.logLevel,
            onProxyReq: this.onRequest
        }));
        this.app.use(process.env.GATEWAY_BASE_PATH, auth.router);
        this.app.use((req, res, next) => {
            let err = new Error('Not Found');
            next(err);
        });
        this.app.use((err, req, res, next) => {
            res.status(err.status || 404);
            res.send({
                message: err.message,
                error: {}
            });
        });
    }
    async onRequest(proxyReq, req, res) {
        proxyReq.removeHeader("Cookie");
        proxyReq.setHeader("Authorization", `Bearer ${req.session.access_token}`);
        let now = new Date().getTime() / 1000;
        if ( /*now >= req.session.access_token_expiration*/true) {
            if (req.session.refresh_token) {
                let body = querystring.stringify({
                    client_id: process.env.STS_CLIENT_ID,
                    client_secret: process.env.STS_CLIENT_SECRET,
                    scope: process.env.STS_CLIENT_SCOPES,
                    refresh_token: req.session.refresh_token,
                    grant_type: 'refresh_token'
                });
                try {
                    let response = await fetch(`${process.env.STS_URL}/connect/token`, {
                        method: 'POST',
                        body: body,
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                    }).then(r => {
                        console.log(r);
                        if (r.status === 200) {
                            return r.json();
                        }
                        console.log("response type not 200");
                        return null;
                    });
                    if (response) {
                        console.log("response, on peut set la session --> " + response);
                        req.session.access_token = response.access_token;
                        req.session.refresh_token = response.refresh_token;
                        console.log("les tokens sont set");
                    }
                    else {
                        console.log("no response");
                        req.session.destroy(err => console.log(err));
                    }
                }
                catch (e) {
                    console.log("Exception lors du renouvellement du token: " + e);
                    req.session.destroy(err => console.log(err));
                }
                console.log("notre session est toujours valide? " + req.sessionID);
                if (req.session && req.session.access_token) {
                    console.log("la session est toujours existante");
                    let payload = JSON.parse(Buffer.from(req.session.access_token.split('.')[1], 'base64').toString());
                    req.session.access_token_expiration = payload.exp;
                    console.log(req.session.access_token_expiration);
                    proxyReq.setHeader("Authorization", `Bearer ${req.session.access_token}`);
                }
                else {
                    // probleme au renouvellement de la session, likely refresh token invvalide, must login
                    console.log("Session invalide apres renouvellement");
                    res.send(401);
                    proxyReq.abort(); // this line drops the request that otherwise still reaches 
                    return;
                }
            }
            else {
                // drop session invalide must login
                console.log("REFRESH TOKEN INVALIDE");
                res.send(401);
                proxyReq.abort(); // this line drops the request that otherwise still reaches 
                return;
            }
        }
        console.log("on set les headers");
        console.log("les headers sont set");
    }
}
exports.Application = Application;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFLLEVBQUUsQ0FBQyxDQUFDLDREQUE0RDtnQkFDOUUsT0FBTzthQUNWO1NBQ0o7UUFDRCxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFFbEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0lBQ3hDLENBQUM7Q0FDSjtBQTNKRCxrQ0EySkMiLCJmaWxlIjoiYXBwLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZXhwcmVzcyBmcm9tICdleHByZXNzJztcclxuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcclxuaW1wb3J0ICogYXMgaHR0cCBmcm9tICdodHRwJztcclxuaW1wb3J0ICogYXMgbG9nZ2VyIGZyb20gJ21vcmdhbic7XHJcbmltcG9ydCAqIGFzIGNvb2tpZVBhcnNlciBmcm9tICdjb29raWUtcGFyc2VyJztcclxuaW1wb3J0ICogYXMgYm9keVBhcnNlciBmcm9tICdib2R5LXBhcnNlcic7XHJcbmltcG9ydCAqIGFzIGNvcnMgZnJvbSAnY29ycyc7XHJcbmltcG9ydCAqIGFzIHNlc3Npb24gZnJvbSAnZXhwcmVzcy1zZXNzaW9uJztcclxuaW1wb3J0ICogYXMgcmVkaXNTdG9yZSBmcm9tICdjb25uZWN0LXJlZGlzJztcclxuaW1wb3J0ICogYXMgaHR0cFByb3h5IGZyb20gJ2h0dHAtcHJveHktbWlkZGxld2FyZSc7XHJcbmltcG9ydCAqIGFzIHF1ZXJ5c3RyaW5nIGZyb20gJ3F1ZXJ5c3RyaW5nJztcclxuaW1wb3J0ICogYXMgZmV0Y2ggZnJvbSAnbm9kZS1mZXRjaCc7XHJcbmNvbnN0IFJlZGlzU3RvcmUgPSByZWRpc1N0b3JlKHNlc3Npb24pO1xyXG5pbXBvcnQgKiBhcyByZWRpcyBmcm9tICdyZWRpcyc7XHJcbmltcG9ydCB7IEF1dGggfSBmcm9tICcuL3JvdXRlL2F1dGgnO1xyXG5pbXBvcnQgeyBhcHBDb25maWcgfSBmcm9tICcuL2FwcC1jb25maWcnO1xyXG5pbXBvcnQgeyBwcm94eUNvbmZpZyB9IGZyb20gJy4vcHJveHktY29uZmlnJztcclxuaW1wb3J0IHsgUkVGVVNFRCB9IGZyb20gJ2Rucyc7XHJcbmltcG9ydCB7IHJ1bkluTmV3Q29udGV4dCB9IGZyb20gJ3ZtJztcclxuaW1wb3J0IHsgSHR0cDJTZWN1cmVTZXJ2ZXIgfSBmcm9tICdodHRwMic7XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIEFwcGxpY2F0aW9uIHtcclxuICAgIFxyXG5cclxuICAgIHB1YmxpYyBhcHA6IGV4cHJlc3MuQXBwbGljYXRpb247XHJcblxyXG4gICAgcHVibGljIHN0YXRpYyBib290c3RyYXAoKTogQXBwbGljYXRpb24ge1xyXG4gICAgICAgIHJldHVybiBuZXcgQXBwbGljYXRpb24oKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICB0aGlzLmFwcCA9IGV4cHJlc3MoKTtcclxuICAgICAgICB0aGlzLmNvbmZpZygpO1xyXG4gICAgICAgIHRoaXMucm91dGVzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjb25maWcoKSB7XHJcbiAgICAgICAgdGhpcy5hcHAudXNlKGxvZ2dlcignZGV2JykpO1xyXG4gICAgICAgIHRoaXMuYXBwLnVzZShib2R5UGFyc2VyLmpzb24oKSk7XHJcbiAgICAgICAgdGhpcy5hcHAudXNlKGJvZHlQYXJzZXIudXJsZW5jb2RlZCh7IGV4dGVuZGVkOiB0cnVlIH0pKTtcclxuICAgICAgICB0aGlzLmFwcC51c2UoY29va2llUGFyc2VyKHByb2Nlc3MuZW52LkNPT0tJRV9TRUNSRVQpKTtcclxuICAgICAgICB0aGlzLmFwcC51c2UoZXhwcmVzcy5zdGF0aWMocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL3B1YmxpYycpKSk7XHJcbiAgICAgICAgdGhpcy5hcHAudXNlKGNvcnMoKSk7XHJcblxyXG4gICAgICAgIGxldCByZWRpc0NsaWVudCA9IHJlZGlzLmNyZWF0ZUNsaWVudCh7XHJcbiAgICAgICAgICAgIGhvc3Q6IHByb2Nlc3MuZW52LlJFRElTX0hPU1QsXHJcbiAgICAgICAgICAgIHBvcnQ6IHByb2Nlc3MuZW52LlJFRElTX1BPUlQsXHJcbiAgICAgICAgICAgIHBhc3N3b3JkOiBwcm9jZXNzLmVudi5SRURJU19QQVNTV09SRCAgIFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHJlZGlzQ2xpZW50Lm9uKFwiZXJyb3JcIiwgZnVuY3Rpb24gKGVycikge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIkVycm9yIFwiICsgZXJyKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgICB0aGlzLmFwcC51c2Uoc2Vzc2lvbih7XHJcbiAgICAgICAgICAgIG5hbWU6ICdjc2dhbWVzLXNlc3Npb24nLFxyXG4gICAgICAgICAgICBzdG9yZTogbmV3IFJlZGlzU3RvcmUoeyBjbGllbnQ6IHJlZGlzQ2xpZW50IH0pLFxyXG4gICAgICAgICAgICByZXNhdmU6IGZhbHNlLFxyXG4gICAgICAgICAgICBzYXZlVW5pbml0aWFsaXplZDogdHJ1ZSxcclxuICAgICAgICAgICAgc2VjcmV0OiBwcm9jZXNzLmVudi5DT09LSUVfU0VDUkVULFxyXG4gICAgICAgICAgICBjb29raWU6IHsgXHJcbiAgICAgICAgICAgICAgICAvLyBUT0RPOiBzZWN1cmU6IHRydWUsXHJcbiAgICAgICAgICAgICAgICBodHRwT25seTogdHJ1ZSxcclxuICAgICAgICAgICAgICAgIGRvbWFpbjogcHJvY2Vzcy5lbnYuQVBQX1VSTCxcclxuICAgICAgICAgICAgICAgIHBhdGg6ICcvJyxcclxuICAgICAgICAgICAgICAgIGV4cGlyZXM6IGFwcENvbmZpZy5jb29raWVFeHBpcmF0aW9uIFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSkpO1xyXG5cclxuICAgICAgICB0aGlzLmFwcC51c2UoZnVuY3Rpb24ocmVxLCByZXMsIG5leHQpIHtcclxuICAgICAgICAgICAgcmVzLnNldEhlYWRlcihcIkFjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpblwiLCBwcm9jZXNzLmVudi5BUFBfVVJMKTtcclxuICAgICAgICAgICAgcmVzLnNldEhlYWRlcihcIlgtWFNTLVByb3RlY3Rpb25cIiwgXCIxOyBtb2RlPWJsb2NrXCIpO1xyXG4gICAgICAgICAgICByZXMuc2V0SGVhZGVyKFwiQ29udGVudC1zZWN1cml0eS1wb2xpY3lcIiwgYXBwQ29uZmlnLmNvbnRlbnRTZWN1cml0eVBvbGljeSk7XHJcbiAgICAgICAgICAgIHJlcy5zZXRIZWFkZXIoXCJYLWZyYW1lLW9wdGlvbnNcIiwgYXBwQ29uZmlnLnhGcmFtZU9wdGlvbnMpO1xyXG4gICAgICAgICAgICByZXMuc2V0SGVhZGVyKFwiWC1jb250ZW50LXR5cGVcIiwgYXBwQ29uZmlnLnhDb250ZW50VHlwZSk7XHJcbiAgICAgICAgICAgIC8vIFRPRE86IHJlcy5zZXRIZWFkZXIoXCJTdHJpY3QtdHJhbnNwb3J0LXNlY3VyaXR5XCIsIGFwcENvbmZpZy5zdHJpY3RUcmFuc3BvcnRTZWN1cml0eSk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gbmV4dCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHRoaXMuYXBwLmRpc2FibGUoJ3gtcG93ZXJlZC1ieScpXHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHJvdXRlcygpIHtcclxuICAgICAgICBjb25zdCBhdXRoOiBBdXRoID0gbmV3IEF1dGgoKTtcclxuICAgICAgICBcclxuICAgICAgICB0aGlzLmFwcC51c2UoaHR0cFByb3h5KHByb3h5Q29uZmlnLnBhdGgsIHsgXHJcbiAgICAgICAgICAgIHRhcmdldDogcHJveHlDb25maWcudGFyZ2V0LCBcclxuICAgICAgICAgICAgcm91dGVyOiBwcm94eUNvbmZpZy5yb3V0ZXIsXHJcbiAgICAgICAgICAgIGxvZ0xldmVsOiBwcm94eUNvbmZpZy5sb2dMZXZlbCxcclxuICAgICAgICAgICAgb25Qcm94eVJlcTogdGhpcy5vblJlcXVlc3QgfSkpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHRoaXMuYXBwLnVzZShwcm9jZXNzLmVudi5HQVRFV0FZX0JBU0VfUEFUSCwgYXV0aC5yb3V0ZXIpO1xyXG5cclxuICAgICAgICB0aGlzLmFwcC51c2UoKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UsIG5leHQ6IGV4cHJlc3MuTmV4dEZ1bmN0aW9uKSA9PiB7XHJcbiAgICAgICAgICAgIGxldCBlcnIgPSBuZXcgRXJyb3IoJ05vdCBGb3VuZCcpO1xyXG4gICAgICAgICAgICBuZXh0KGVycik7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMuYXBwLnVzZSgoZXJyOiBhbnksIHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UsIG5leHQ6IGV4cHJlc3MuTmV4dEZ1bmN0aW9uKSA9PiB7XHJcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoZXJyLnN0YXR1cyB8fCA0MDQpO1xyXG4gICAgICAgICAgICByZXMuc2VuZCh7XHJcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiBlcnIubWVzc2FnZSxcclxuICAgICAgICAgICAgICAgIGVycm9yOiB7fVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGFzeW5jIG9uUmVxdWVzdChwcm94eVJlcTogaHR0cC5DbGllbnRSZXF1ZXN0LCByZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKSB7XHJcbiAgICAgICAgcHJveHlSZXEucmVtb3ZlSGVhZGVyKFwiQ29va2llXCIpO1xyXG4gICAgICAgIHByb3h5UmVxLnNldEhlYWRlcihcIkF1dGhvcml6YXRpb25cIiwgYEJlYXJlciAke3JlcS5zZXNzaW9uLmFjY2Vzc190b2tlbn1gKTtcclxuXHJcbiAgICAgICAgbGV0IG5vdyA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpIC8gMTAwMDtcclxuICAgICAgICBpZiAoLypub3cgPj0gcmVxLnNlc3Npb24uYWNjZXNzX3Rva2VuX2V4cGlyYXRpb24qL3RydWUpIHtcclxuICAgICAgICAgICAgaWYgKHJlcS5zZXNzaW9uLnJlZnJlc2hfdG9rZW4pIHtcclxuICAgICAgICAgICAgICAgIGxldCBib2R5ID0gcXVlcnlzdHJpbmcuc3RyaW5naWZ5KHtcclxuICAgICAgICAgICAgICAgICAgICBjbGllbnRfaWQ6IHByb2Nlc3MuZW52LlNUU19DTElFTlRfSUQsXHJcbiAgICAgICAgICAgICAgICAgICAgY2xpZW50X3NlY3JldDogcHJvY2Vzcy5lbnYuU1RTX0NMSUVOVF9TRUNSRVQsXHJcbiAgICAgICAgICAgICAgICAgICAgc2NvcGU6IHByb2Nlc3MuZW52LlNUU19DTElFTlRfU0NPUEVTLFxyXG4gICAgICAgICAgICAgICAgICAgIHJlZnJlc2hfdG9rZW46IHJlcS5zZXNzaW9uLnJlZnJlc2hfdG9rZW4sXHJcbiAgICAgICAgICAgICAgICAgICAgZ3JhbnRfdHlwZTogJ3JlZnJlc2hfdG9rZW4nXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goYCR7cHJvY2Vzcy5lbnYuU1RTX1VSTH0vY29ubmVjdC90b2tlbmAsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJvZHk6IGJvZHksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM6IHsnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCd9XHJcbiAgICAgICAgICAgICAgICAgICAgfSkudGhlbihyID0+IHsgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoci5zdGF0dXMgPT09IDIwMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHIuanNvbigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwicmVzcG9uc2UgdHlwZSBub3QgMjAwXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2Upe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcInJlc3BvbnNlLCBvbiBwZXV0IHNldCBsYSBzZXNzaW9uIC0tPiBcIiArIHJlc3BvbnNlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmVxLnNlc3Npb24uYWNjZXNzX3Rva2VuID0gcmVzcG9uc2UuYWNjZXNzX3Rva2VuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXEuc2Vzc2lvbi5yZWZyZXNoX3Rva2VuID0gcmVzcG9uc2UucmVmcmVzaF90b2tlbjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJsZXMgdG9rZW5zIHNvbnQgc2V0XCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwibm8gcmVzcG9uc2VcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlcS5zZXNzaW9uLmRlc3Ryb3koZXJyID0+IGNvbnNvbGUubG9nKGVycikpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiRXhjZXB0aW9uIGxvcnMgZHUgcmVub3V2ZWxsZW1lbnQgZHUgdG9rZW46IFwiICsgZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVxLnNlc3Npb24uZGVzdHJveShlcnIgPT4gY29uc29sZS5sb2coZXJyKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIm5vdHJlIHNlc3Npb24gZXN0IHRvdWpvdXJzIHZhbGlkZT8gXCIgKyByZXEuc2Vzc2lvbklEKTtcclxuICAgICAgICAgICAgICAgIGlmIChyZXEuc2Vzc2lvbiAmJiByZXEuc2Vzc2lvbi5hY2Nlc3NfdG9rZW4pIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcImxhIHNlc3Npb24gZXN0IHRvdWpvdXJzIGV4aXN0YW50ZVwiKTtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgcGF5bG9hZCA9IEpTT04ucGFyc2UoQnVmZmVyLmZyb20ocmVxLnNlc3Npb24uYWNjZXNzX3Rva2VuLnNwbGl0KCcuJylbMV0sICdiYXNlNjQnKS50b1N0cmluZygpKTtcclxuICAgICAgICAgICAgICAgICAgICByZXEuc2Vzc2lvbi5hY2Nlc3NfdG9rZW5fZXhwaXJhdGlvbiA9IHBheWxvYWQuZXhwO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlcS5zZXNzaW9uLmFjY2Vzc190b2tlbl9leHBpcmF0aW9uKTtcclxuICAgICAgICAgICAgICAgICAgICBwcm94eVJlcS5zZXRIZWFkZXIoXCJBdXRob3JpemF0aW9uXCIsIGBCZWFyZXIgJHtyZXEuc2Vzc2lvbi5hY2Nlc3NfdG9rZW59YCk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIHByb2JsZW1lIGF1IHJlbm91dmVsbGVtZW50IGRlIGxhIHNlc3Npb24sIGxpa2VseSByZWZyZXNoIHRva2VuIGludnZhbGlkZSwgbXVzdCBsb2dpblxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiU2Vzc2lvbiBpbnZhbGlkZSBhcHJlcyByZW5vdXZlbGxlbWVudFwiKTtcclxuICAgICAgICAgICAgICAgICAgICByZXMuc2VuZCg0MDEpO1xyXG4gICAgICAgICAgICAgICAgICAgIHByb3h5UmVxLmFib3J0KCk7IC8vIHRoaXMgbGluZSBkcm9wcyB0aGUgcmVxdWVzdCB0aGF0IG90aGVyd2lzZSBzdGlsbCByZWFjaGVzIFxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAvLyBkcm9wIHNlc3Npb24gaW52YWxpZGUgbXVzdCBsb2dpblxyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJSRUZSRVNIIFRPS0VOIElOVkFMSURFXCIpO1xyXG4gICAgICAgICAgICAgICAgcmVzLnNlbmQoNDAxKTtcclxuICAgICAgICAgICAgICAgIHByb3h5UmVxLmFib3J0KCk7IC8vIHRoaXMgbGluZSBkcm9wcyB0aGUgcmVxdWVzdCB0aGF0IG90aGVyd2lzZSBzdGlsbCByZWFjaGVzIFxyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnNvbGUubG9nKFwib24gc2V0IGxlcyBoZWFkZXJzXCIpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnNvbGUubG9nKFwibGVzIGhlYWRlcnMgc29udCBzZXRcIik7XHJcbiAgICB9XHJcbn1cclxuIl19
